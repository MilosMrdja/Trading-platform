<app-loading *ngIf="loading"></app-loading>
<app-error-page *ngIf="error && !loading" [message]="error"></app-error-page>

<div *ngIf="!loading && !error" class="relative overflow-x-auto shadow-md sm:rounded-lg">
  <div class="mb-6 flex items-center justify-between">
    <!-- Leva strana -->
    <div class="flex items-center gap-4">
      <h2 class="text-3xl ml-10 mt-1 font-extrabold text-gray-800 dark:text-gray-700 tracking-wide">Trades</h2>
      <button (click)="openAddModal()" class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full hover:bg-green-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
      </button>
    </div>

    <!-- Desna strana (filteri) -->
    <div class="flex items-end gap-4">
      <!-- Direction Filter -->
      <div>
        <label class="block text-sm mb-2 text-gray-500 dark:text-gray-400">Direction</label>
        <select
          [(ngModel)]="filters.direction"
          class="px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white"
        >
          <option value="">All</option>
          <option value="BUY">Buy</option>
          <option value="SELL">Sell</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block text-sm mb-2 text-gray-500 dark:text-gray-400">Status</label>
        <select
          [(ngModel)]="filters.status"
          class="px-3 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white"
        >
          <option value="">All</option>
          <option value="OPEN">Open</option>
          <option value="MATCHED">Matched</option>
          <option value="EXERCISED">Exercised</option>
          <option value="CLOSED">Closed</option>
        </select>
      </div>

      <!-- Price Filter -->
      <div>
        <label class="block text-sm mb-2 text-gray-500 dark:text-gray-400">Price</label>
        <input
          type="number"
          [(ngModel)]="filters.price"
          class="w-28 px-2 py-2 border border-gray-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-white"
          [placeholder]="filters.price === null ? 'Enter price' : ''"
        />
      </div>


      <!-- Search Filters -->
      <button (click)="applyFilters()"
              class="p-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"/>
        </svg>
      </button>

      <!-- Reset Filters -->
      <button (click)="resetFilters()" class="p-2 bg-gray-200 dark:bg-gray-600 rounded hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700 dark:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582M20 20v-5h-.581M5.582 9A7.5 7.5 0 0112 5.5a7.5 7.5 0 016.418 3.5M18.418 15A7.5 7.5 0 0112 18.5a7.5 7.5 0 01-6.418-3.5"/>
        </svg>
      </button>
    </div>

  </div>


  <table class="w-full text-base text-left text-gray-700 dark:text-gray-300">
    <thead class="text-sm font-bold uppercase bg-gray-100 dark:bg-gray-700 dark:text-gray-400">
    <tr>
      <th class="px-6 py-3">ID</th>
      <th class="px-6 py-3">Instrument</th>
      <th class="px-6 py-3">Account</th>
      <th class="px-6 py-3">Quantity</th>
      <th class="px-6 py-3">Price</th>
      <th class="px-6 py-3">Direction</th>
      <th class="px-6 py-3">Delivery Type</th>
      <th class="px-6 py-3">Unit</th>
      <th class="px-6 py-3">Status</th>
      <th class="px-6 py-3 text-right">Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let trade of trades" class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
      <td class="px-6 py-4 font-medium">{{ trade.id }}</td>
      <td class="px-6 py-4 font-medium">{{ trade.instrument.code }}</td>
      <td class="px-6 py-4 font-medium">{{ trade.account.name }}</td>
      <td class="px-6 py-4 font-medium">{{ trade.quantity }}</td>
      <td class="px-6 py-4 font-medium">{{ trade.price }}</td>
      <td class="px-6 py-4 font-medium">{{ trade.direction }}</td>
      <td class="px-6 py-4 font-medium">{{ formatEnum(trade.deliveryType.toString()) }}</td>
      <td class="px-6 py-4 font-medium">{{ formatEnum(trade.unit.toString()) }}</td>

      <td class="px-6 py-4 font-medium">{{ trade.status }}</td>
      <td class="px-6 py-4 text-right flex justify-end gap-2">
        <button [disabled]="isTradeOpen(trade)" (click)="exerciseTrade(trade)" class="px-3 py-1 rounded bg-yellow-300 dark:bg-yellow-500 text-gray-300 dark:text-gray-800 hover:bg-yellow-400 dark:hover:bg-yellow-600">
          <b>Exercise</b>
        </button>

        <button [disabled]="isTradeOpen(trade)" (click)="openEditModal(trade)" class="p-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M16.5 3.75a2.121 2.121 0 113 3L7 19.25H4v-3L16.5 3.75z"/>
          </svg>
        </button>
        <button (click)="openDeleteModal(trade)" class="p-2 bg-red-600 text-white rounded hover:bg-red-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7L5 21M5 7l14 14"/>
          </svg>
        </button>
      </td>
    </tr>
    <tr *ngIf="trades.length === 0">
      <td colspan="4" class="text-center py-6 text-gray-500 italic">
        There is no data
      </td>
    </tr>
    </tbody>
  </table>
</div>

<app-pagination *ngIf="!loading && !error" [currentPage]="currentPage" [totalPages]="totalPages" (pageChange)="goToPage($event)"></app-pagination>

<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96 relative">
    <app-trade-form [tradeToEdit]="tradeToEdit" (closed)="closeModal()" (formSubmitted)="onFormSubmitted()"></app-trade-form>
  </div>
</div>

<app-confirmation-modal
  [visible]="showDeleteModal"
  title="Delete Trade"
  message="Are you sure you want to delete this trade?"
  (confirmed)="confirmDelete()"
  (cancelled)="closeDeleteModal()">
</app-confirmation-modal>

<app-toast></app-toast>
